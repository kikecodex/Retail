{% extends "base.html" %}

{% block header %}ü§ñ Modo Autom√°tico{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="mb-6 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-6 text-white shadow-lg">
        <h1 class="text-2xl font-bold">ü§ñ Generador Autom√°tico de Reportes</h1>
        <p class="text-emerald-100 mt-1">Selecciona el tipo de suelo ‚Üí ajusta par√°metros (opcional) ‚Üí genera reporte
            completo de 8 p√°ginas</p>
        <div class="flex gap-3 mt-3">
            <span class="px-3 py-1 bg-white/20 rounded-full text-xs font-semibold">Terzaghi + Meyerhof</span>
            <span class="px-3 py-1 bg-white/20 rounded-full text-xs font-semibold">8 P√°ginas ASTM</span>
            <span class="px-3 py-1 bg-white/20 rounded-full text-xs font-semibold">Datos Sint√©ticos</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- LEFT: Parameters Panel -->
        <div class="lg:col-span-1 space-y-4">

            <!-- Zone Selector -->
            <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-violet-500">
                <h3 class="font-bold text-gray-700 mb-3">üåé Ubicaci√≥n Geogr√°fica</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Departamento</label>
                        <select id="departmentSelect" onchange="onDepartmentChange()"
                            class="w-full p-2 border-2 border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-violet-500">
                            <option value="">-- Opcional --</option>
                            {% for key, dept in departments.items() %}
                            <option value="{{ key }}" data-zone="{{ dept.zone }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Altitud (m.s.n.m.)</label>
                        <input type="number" id="altitudeInput" placeholder="ej: 3800" min="0" max="6000"
                            onchange="loadSoilDefaults()"
                            class="w-full p-2 border-2 border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-violet-500">
                    </div>
                </div>
                <select id="zoneSelect" onchange="loadSoilDefaults()"
                    class="w-full p-3 border-2 border-violet-300 rounded-lg text-lg font-bold focus:ring-2 focus:ring-violet-500 focus:border-violet-500">
                    <option value="">-- Sin zona (rangos nacionales) --</option>
                    {% for key, zone in zone_profiles.items() %}
                    <option value="{{ key }}" data-color="{{ zone.color }}">
                        {{ zone.emoji }} {{ zone.label }} ‚Äî {{ zone.description }}
                    </option>
                    {% endfor %}
                </select>
                <p id="zoneIndicator" class="text-xs text-gray-400 mt-1"></p>
            </div>

            <!-- SUCS Selector -->
            <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-emerald-500">
                <h3 class="font-bold text-gray-700 mb-3">üè∑Ô∏è Tipo de Suelo (SUCS)</h3>
                <select id="sucsSelect" onchange="loadSoilDefaults()"
                    class="w-full p-3 border-2 border-emerald-300 rounded-lg text-lg font-bold focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="">-- Seleccionar --</option>
                    {% for symbol, data in soil_params.items() %}
                    <option value="{{ symbol }}">{{ symbol }} ‚Äî {{ data.name }}</option>
                    {% endfor %}
                </select>
                <p id="soilCategory" class="text-xs text-gray-400 mt-1"></p>
            </div>

            <!-- Soil Parameters -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-gray-700">üìê Par√°metros del Suelo</h3>
                    <span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full"
                        id="modeIndicator">Autom√°tico</span>
                </div>
                <p class="text-xs text-gray-400 mb-3">Se autocargan de la CARTILLA. Edita si tienes valores reales.</p>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500">œÜ (¬∞)</label>
                        <input type="number" id="phi" step="0.1"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="25.0">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">c (kg/cm¬≤)</label>
                        <input type="number" id="cohesion" step="0.001"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="0.05">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">LL (%)</label>
                        <input type="number" id="ll" step="0.1" class="w-full p-2 border rounded-lg text-sm param-input"
                            oninput="markManual(this)" placeholder="30">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">LP (%)</label>
                        <input type="number" id="pl" step="0.1" class="w-full p-2 border rounded-lg text-sm param-input"
                            oninput="markManual(this)" placeholder="20">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Humedad (%)</label>
                        <input type="number" id="humedad" step="0.1"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="10">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Gs</label>
                        <input type="number" id="gs" step="0.01"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="2.65">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">MDD (g/cm¬≥)</label>
                        <input type="number" id="mdd" step="0.01"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="1.75">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">OMC (%)</label>
                        <input type="number" id="omc" step="0.1"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="12">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">% Finos</label>
                        <input type="number" id="fines_pct" step="0.1"
                            class="w-full p-2 border rounded-lg text-sm param-input" oninput="markManual(this)"
                            placeholder="50">
                    </div>
                </div>
            </div>

            <!-- Foundation Parameters -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <h3 class="font-bold text-gray-700 mb-3">üèóÔ∏è Cimentaci√≥n</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500">Ancho B (m)</label>
                        <input type="number" id="B" step="0.1" value="1.0" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Largo L (m)</label>
                        <input type="number" id="L" step="0.1" value="1.0" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">Prof. Df (m)
                            <span id="dfAutoLabel" class="text-emerald-500 text-[10px] hidden">‚Üê auto</span>
                        </label>
                        <input type="number" id="Df" step="0.1" value="1.5"
                            class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">FS</label>
                        <input type="number" id="FS" step="0.5" value="3" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-gray-500">Tipo</label>
                        <select id="foundation_type" class="w-full p-2 border rounded-lg text-sm">
                            <option value="square">Cuadrada</option>
                            <option value="strip">Corrida</option>
                            <option value="circular">Circular</option>
                        </select>
                    </div>
                </div>

                <!-- NTE E.050 Extended -->
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold text-gray-600">üìê NTE E.050</span>
                        <span class="text-[10px] text-gray-400">Nivel Fre√°tico y Edificaci√≥n</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-gray-500">Œ≥sat (Tn/m¬≥)</label>
                            <input type="number" id="gamma_sat" step="0.01" value="" placeholder="ej: 1.9"
                                class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Prof. NF (m)</label>
                            <input type="number" id="water_table" step="0.1" value="" placeholder="vac√≠o = sin NF"
                                class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">N¬∞ Niveles</label>
                            <input type="number" id="num_levels" step="1" value="" placeholder="auto Df"
                                oninput="autoCalcDf()" class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Categor√≠a</label>
                            <select id="building_category" class="w-full p-2 border rounded-lg text-sm">
                                <option value="">-- (opcional) --</option>
                                <option value="A">A ‚Äî Cr√≠tica</option>
                                <option value="B" selected>B ‚Äî Est√°ndar</option>
                                <option value="C">C ‚Äî Menor</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Info -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <h3 class="font-bold text-gray-700 mb-3">üìÅ Datos del Proyecto</h3>
                <div class="space-y-2">
                    <input type="text" id="proyecto" placeholder="Nombre del proyecto"
                        class="w-full p-2 border rounded-lg text-sm">
                    <input type="text" id="ubicacion" placeholder="Ubicaci√≥n"
                        class="w-full p-2 border rounded-lg text-sm">
                    <input type="text" id="solicitante" placeholder="Solicitante"
                        class="w-full p-2 border rounded-lg text-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="calicata" placeholder="Calicata (C-01)" value="C-01"
                            class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="profundidad" placeholder="Prof. (1.5 m)" value="1.5 m"
                            class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="muestra" placeholder="Muestra (M-01)" value="M-01"
                            class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="tecnico" placeholder="T√©cnico" value="J.L.C."
                            class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <input type="text" id="fecha" placeholder="Fecha" class="w-full p-2 border rounded-lg text-sm">
                </div>
            </div>

            <!-- GENERATE BUTTON -->
            <button onclick="generateReport()" id="btnGenerate"
                class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                üöÄ GENERAR REPORTE COMPLETO
            </button>
        </div>

        <!-- RIGHT: Results Panel -->
        <div class="lg:col-span-2">
            <!-- Summary Cards (hidden until generation) -->
            <div id="summaryPanel" class="hidden mb-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white rounded-xl p-4 shadow-md border-t-4 border-blue-500 text-center">
                        <div class="text-xs text-gray-400">SUCS</div>
                        <div class="text-2xl font-bold text-blue-600" id="sumSucs">--</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-md border-t-4 border-amber-500 text-center">
                        <div class="text-xs text-gray-400">œÜ / c</div>
                        <div class="text-lg font-bold text-amber-600" id="sumShear">--</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-md border-t-4 border-emerald-500 text-center">
                        <div class="text-xs text-gray-400">qa Terzaghi</div>
                        <div class="text-lg font-bold text-emerald-600" id="sumTerzaghi">--</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-md border-t-4 border-purple-500 text-center">
                        <div class="text-xs text-gray-400">qa Meyerhof</div>
                        <div class="text-lg font-bold text-purple-600" id="sumMeyerhof">--</div>
                    </div>
                </div>
            </div>

            <!-- Report Preview -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden" style="min-height: 600px;">
                <div class="bg-gray-100 px-4 py-3 flex items-center justify-between border-b">
                    <span class="text-sm font-semibold text-gray-600">üìÑ Vista Previa del Reporte</span>
                    <div class="flex gap-2">
                        <button onclick="printReport()" id="btnPrint"
                            class="hidden px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600 transition">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button onclick="downloadReport()" id="btnDownload"
                            class="hidden px-3 py-1 bg-emerald-500 text-white rounded-lg text-xs hover:bg-emerald-600 transition">
                            üíæ Descargar HTML
                        </button>
                    </div>
                </div>

                <!-- Placeholder -->
                <div id="reportPlaceholder" class="flex flex-col items-center justify-center py-20 text-gray-400">
                    <div class="text-6xl mb-4">üìã</div>
                    <p class="text-lg font-medium">Selecciona un tipo de suelo y haz clic en</p>
                    <p class="text-lg font-bold text-emerald-500">üöÄ GENERAR REPORTE COMPLETO</p>
                    <p class="text-sm mt-2">El reporte de 8 p√°ginas aparecer√° aqu√≠</p>
                </div>

                <!-- Loading -->
                <div id="reportLoading" class="hidden flex flex-col items-center justify-center py-20">
                    <div
                        class="animate-spin rounded-full h-16 w-16 border-4 border-emerald-200 border-t-emerald-500 mb-4">
                    </div>
                    <p class="text-lg font-medium text-gray-500" id="loadingText">Generando datos sint√©ticos...</p>
                    <div class="mt-3 w-64 bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-emerald-500 h-2 rounded-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Report iframe -->
                <iframe id="reportFrame" class="hidden w-full border-0" style="height: 800px;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    // Soil parameters from CARTILLA (passed from backend)
    const SOIL_DB = {{ soil_params | tojson }};

    // Zone profiles from backend
    const ZONE_DB = {{ zone_profiles | tojson }};

    // Department data from backend
    const DEPT_DB = {{ departments | tojson }};

    let generatedHtml = null;

    function onDepartmentChange() {
        const dept = document.getElementById('departmentSelect').value;
        if (dept && DEPT_DB[dept]) {
            const deptData = DEPT_DB[dept];
            // Auto-select zone
            document.getElementById('zoneSelect').value = deptData.zone;
            // Fill altitude with capital altitude
            document.getElementById('altitudeInput').value = deptData.capital_alt;
        }
        loadSoilDefaults();
    }

    function avg(range) {
        if (!range) return '';
        return ((range[0] + range[1]) / 2).toFixed(2);
    }

    function loadSoilDefaults() {
        const sucs = document.getElementById('sucsSelect').value;
        const zone = document.getElementById('zoneSelect').value;
        if (!sucs || !SOIL_DB[sucs]) return;

        const soil = SOIL_DB[sucs];
        document.getElementById('soilCategory').textContent = `Categor√≠a: ${soil.category} ‚Äî ${soil.name}`;

        // Use zone-specific ranges if zone is selected, otherwise national ranges
        let ranges = soil;
        if (zone && ZONE_DB[zone] && ZONE_DB[zone][sucs]) {
            ranges = ZONE_DB[zone][sucs];
            const zi = ZONE_DB[zone];
            document.getElementById('zoneIndicator').textContent =
                `${zi.emoji} ${zi.label}: Rangos ajustados para ${sucs}`;
            document.getElementById('zoneIndicator').style.color = zi.color;
        } else if (zone) {
            document.getElementById('zoneIndicator').textContent =
                `‚ö†Ô∏è Sin perfil regional para ${sucs} en ${zone}, usando rangos nacionales`;
            document.getElementById('zoneIndicator').style.color = '#F59E0B';
        } else {
            document.getElementById('zoneIndicator').textContent = '';
        }

        // Auto-fill with zone-specific or CARTILLA averages
        document.getElementById('phi').value = avg(ranges.phi || soil.phi);
        document.getElementById('cohesion').value = avg(ranges.cohesion || soil.cohesion);
        document.getElementById('ll').value = (ranges.ll || soil.ll) ? avg(ranges.ll || soil.ll) : '';
        document.getElementById('pl').value = (ranges.lp || soil.lp) ? avg(ranges.lp || soil.lp) : '';
        document.getElementById('humedad').value = avg(ranges.humedad || soil.humedad);
        document.getElementById('gs').value = (ranges.peso_especifico || soil.peso_especifico) ? avg(ranges.peso_especifico || soil.peso_especifico) : '2.65';
        document.getElementById('mdd').value = (ranges.mdd || soil.mdd) ? avg(ranges.mdd || soil.mdd) : '';
        document.getElementById('omc').value = (ranges.omc || soil.omc) ? avg(ranges.omc || soil.omc) : '';
        document.getElementById('fines_pct').value = (ranges.finos_percent || soil.finos_percent) ? avg(ranges.finos_percent || soil.finos_percent) : '50';

        // Reset manual indicators + validate all fields
        document.querySelectorAll('.param-input').forEach(el => {
            el.classList.remove('border-amber-400', 'bg-amber-50',
                'border-red-400', 'bg-red-50');
            el.classList.add('border-emerald-300', 'bg-emerald-50');
            // Remove any warning tooltip
            const tip = el.parentElement.querySelector('.range-tip');
            if (tip) tip.remove();
        });
        document.getElementById('modeIndicator').textContent = 'Autom√°tico';
        document.getElementById('modeIndicator').className = 'text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full';
    }

    function autoCalcDf() {
        const n = parseInt(document.getElementById('num_levels').value);
        if (!n || n < 1) {
            document.getElementById('dfAutoLabel').classList.add('hidden');
            return;
        }
        const df = Math.max(1.0, 0.80 + 0.20 * (n - 2));
        document.getElementById('Df').value = df.toFixed(2);
        document.getElementById('dfAutoLabel').classList.remove('hidden');
    }

    // Mapping: input element ID ‚Üí SOIL_DB parameter key
    const FIELD_RANGE_MAP = {
        'phi': 'phi',
        'cohesion': 'cohesion',
        'll': 'll',
        'pl': 'lp',
        'humedad': 'humedad',
        'gs': 'peso_especifico',
        'mdd': 'mdd',
        'omc': 'omc',
        'fines_pct': 'finos_percent'
    };

    function validateField(el) {
        const sucs = document.getElementById('sucsSelect').value;
        if (!sucs || !SOIL_DB[sucs]) return;

        const soil = SOIL_DB[sucs];
        const fieldId = el.id;
        const rangeKey = FIELD_RANGE_MAP[fieldId];
        if (!rangeKey || !soil[rangeKey]) return;

        const range = soil[rangeKey];
        const val = parseFloat(el.value);
        if (isNaN(val)) return;

        // Remove old tooltip
        const oldTip = el.parentElement.querySelector('.range-tip');
        if (oldTip) oldTip.remove();

        const [min, max] = range;
        const span = max - min;
        const tolerance = span * 0.15;

        // Reset classes
        el.classList.remove('border-emerald-300', 'bg-emerald-50',
            'border-amber-400', 'bg-amber-50',
            'border-red-400', 'bg-red-50');

        if (val >= min && val <= max) {
            // In range ‚Äî green
            el.classList.add('border-emerald-300', 'bg-emerald-50');
        } else if (val >= (min - tolerance) && val <= (max + tolerance)) {
            // Slightly outside ‚Äî amber warning
            el.classList.add('border-amber-400', 'bg-amber-50');
            const tip = document.createElement('div');
            tip.className = 'range-tip text-xs text-amber-600 mt-1';
            tip.textContent = `‚ö†Ô∏è Ligeramente fuera del rango (${min} - ${max})`;
            el.parentElement.appendChild(tip);
        } else {
            // Far outside ‚Äî red error
            el.classList.add('border-red-400', 'bg-red-50');
            const tip = document.createElement('div');
            tip.className = 'range-tip text-xs text-red-600 mt-1';
            tip.textContent = `‚ùå Fuera del rango esperado (${min} - ${max})`;
            el.parentElement.appendChild(tip);
        }
    }

    function markManual(el) {
        // Validate against cartilla range
        validateField(el);

        // If not in range styling already set by validateField, ensure amber minimum
        if (!el.classList.contains('border-red-400') && !el.classList.contains('border-amber-400')) {
            // Value is in range but manually edited ‚Äî keep green but mark hybrid
        }

        document.getElementById('modeIndicator').textContent = 'H√≠brido';
        document.getElementById('modeIndicator').className = 'text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded-full';
    }

    async function generateReport() {
        const sucs = document.getElementById('sucsSelect').value;
        if (!sucs) {
            alert('Selecciona un tipo de suelo primero');
            return;
        }

        const btn = document.getElementById('btnGenerate');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Generando...';

        // Show loading
        document.getElementById('reportPlaceholder').classList.add('hidden');
        document.getElementById('reportFrame').classList.add('hidden');
        document.getElementById('reportLoading').classList.remove('hidden');

        // Animate progress
        const progress = document.getElementById('progressBar');
        const loadingText = document.getElementById('loadingText');

        const steps = [
            [10, 'Generando datos sint√©ticos...'],
            [30, 'Calculando granulometr√≠a y l√≠mites...'],
            [50, 'Procesando corte directo y proctor...'],
            [70, 'Calculando Terzaghi y Meyerhof...'],
            [85, 'Generando reporte HTML...'],
        ];

        let stepIdx = 0;
        const progressInterval = setInterval(() => {
            if (stepIdx < steps.length) {
                progress.style.width = steps[stepIdx][0] + '%';
                loadingText.textContent = steps[stepIdx][1];
                stepIdx++;
            }
        }, 600);

        try {
            const payload = {
                sucs,
                zone: document.getElementById('zoneSelect').value || '',
                department: document.getElementById('departmentSelect').value || '',
                altitude: document.getElementById('altitudeInput').value || '',
                phi: document.getElementById('phi').value || 25,
                cohesion: document.getElementById('cohesion').value || 0.05,
                ll: document.getElementById('ll').value || 30,
                pl: document.getElementById('pl').value || 20,
                humedad: document.getElementById('humedad').value || 10,
                gs: document.getElementById('gs').value || 2.65,
                mdd: document.getElementById('mdd').value || 1.75,
                omc: document.getElementById('omc').value || 12,
                fines_pct: document.getElementById('fines_pct').value || 50,
                B: document.getElementById('B').value,
                L: document.getElementById('L').value,
                Df: document.getElementById('Df').value,
                FS: document.getElementById('FS').value,
                foundation_type: document.getElementById('foundation_type').value,
                gamma_sat: document.getElementById('gamma_sat').value || '',
                water_table: document.getElementById('water_table').value || '',
                num_levels: document.getElementById('num_levels').value || '',
                building_category: document.getElementById('building_category').value || '',
                proyecto: document.getElementById('proyecto').value,
                ubicacion: document.getElementById('ubicacion').value,
                solicitante: document.getElementById('solicitante').value,
                calicata: document.getElementById('calicata').value,
                profundidad: document.getElementById('profundidad').value,
                muestra: document.getElementById('muestra').value,
                tecnico: document.getElementById('tecnico').value,
                fecha: document.getElementById('fecha').value || new Date().toLocaleDateString('es-PE'),
            };

            const resp = await fetch('/api/generar_reporte', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();

            clearInterval(progressInterval);

            if (data.success) {
                progress.style.width = '100%';
                loadingText.textContent = '‚úÖ ¬°Reporte generado!';

                generatedHtml = data.html;

                // Update summary cards
                const s = data.summary;
                document.getElementById('sumSucs').textContent = s.sucs;
                document.getElementById('sumShear').textContent = `${Number(s.phi).toFixed(1)}¬∞ / ${Number(s.cohesion).toFixed(3)}`;
                document.getElementById('sumTerzaghi').textContent = `${Number(s.qa_terzaghi).toFixed(2)} kg/cm¬≤`;
                document.getElementById('sumMeyerhof').textContent = `${Number(s.qa_meyerhof).toFixed(2)} kg/cm¬≤`;
                document.getElementById('summaryPanel').classList.remove('hidden');

                // Show report in iframe
                setTimeout(() => {
                    document.getElementById('reportLoading').classList.add('hidden');
                    const iframe = document.getElementById('reportFrame');
                    iframe.classList.remove('hidden');
                    iframe.srcdoc = data.html;
                    document.getElementById('btnPrint').classList.remove('hidden');
                    document.getElementById('btnDownload').classList.remove('hidden');
                }, 500);
            } else {
                alert('Error: ' + data.error);
                document.getElementById('reportLoading').classList.add('hidden');
                document.getElementById('reportPlaceholder').classList.remove('hidden');
            }

        } catch (err) {
            clearInterval(progressInterval);
            alert('Error de conexi√≥n: ' + err.message);
            document.getElementById('reportLoading').classList.add('hidden');
            document.getElementById('reportPlaceholder').classList.remove('hidden');
        }

        btn.disabled = false;
        btn.innerHTML = 'üöÄ GENERAR REPORTE COMPLETO';
    }

    function printReport() {
        if (!generatedHtml) return;
        const win = window.open('', '_blank');
        win.document.write(generatedHtml);
        win.document.close();
        setTimeout(() => win.print(), 500);
    }

    function downloadReport() {
        if (!generatedHtml) return;
        const blob = new Blob([generatedHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const calicata = document.getElementById('calicata').value || 'C-01';
        a.href = url;
        a.download = `Reporte_${calicata}_${document.getElementById('sucsSelect').value}.html`;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}