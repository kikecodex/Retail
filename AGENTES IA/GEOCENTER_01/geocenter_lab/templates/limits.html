{% extends "base.html" %}

{% block header %}L√≠mites de Consistencia (Visual + H√∫medo){% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">

    <!-- LEFT: Data Entry -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">üî¢ Datos de Laboratorio</h3>
            <button onclick="calculateLimits()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition-all font-semibold flex items-center gap-2">
                ‚ö° Calcular
            </button>
        </div>

        <div class="p-6 overflow-auto">
            <!-- Liquid Limit Section -->
            <div class="mb-8">
                <h4 class="text-sm font-bold text-blue-600 uppercase mb-3 border-b pb-1">L√≠mite L√≠quido (Copa
                    Casagrande)</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-center">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                            <tr>
                                <th class="p-2">Ensayo #</th>
                                <th class="p-2">Golpes</th>
                                <th class="p-2">P. H√∫medo + T</th>
                                <th class="p-2">P. Seco + T</th>
                                <th class="p-2">Tara</th>
                            </tr>
                        </thead>
                        <tbody id="ll-body">
                            <!-- 4 Rows for entries -->
                            {% for i in range(1, 5) %}
                            <tr class="ll-row">
                                <td class="p-2 font-bold text-gray-400">{{ i }}</td>
                                <td class="p-1"><input type="number" class="blows w-16 p-1 border rounded text-center"
                                        placeholder="N"></td>
                                <td class="p-1"><input type="number" step="0.01"
                                        class="wt w-20 p-1 border rounded text-center"></td>
                                <td class="p-1"><input type="number" step="0.01"
                                        class="dt w-20 p-1 border rounded text-center"></td>
                                <td class="p-1"><input type="number" step="0.01"
                                        class="t w-20 p-1 border rounded text-center"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Plastic Limit Section -->
            <div>
                <h4 class="text-sm font-bold text-green-600 uppercase mb-3 border-b pb-1">L√≠mite Pl√°stico</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-center">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                            <tr>
                                <th class="p-2">Ensayo #</th>
                                <th class="p-2">P. H√∫medo + T</th>
                                <th class="p-2">P. Seco + T</th>
                                <th class="p-2">Tara</th>
                            </tr>
                        </thead>
                        <tbody id="pl-body">
                            {% for i in range(1, 3) %}
                            <tr class="pl-row">
                                <td class="p-2 font-bold text-gray-400">{{ i }}</td>
                                <td class="p-1"><input type="number" step="0.01"
                                        class="wt w-24 p-1 border rounded text-center"></td>
                                <td class="p-1"><input type="number" step="0.01"
                                        class="dt w-24 p-1 border rounded text-center"></td>
                                <td class="p-1"><input type="number" step="0.01"
                                        class="t w-24 p-1 border rounded text-center"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: Results & Chart -->
    <div class="flex flex-col gap-6 h-full">

        <!-- Summary Cards -->
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold">L√≠mite L√≠quido</div>
                <div class="text-3xl font-bold text-gray-800" id="res-ll">--</div>
                <div class="text-xs text-gray-400">%</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-green-500 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold">L√≠mite Pl√°stico</div>
                <div class="text-3xl font-bold text-gray-800" id="res-pl">--</div>
                <div class="text-xs text-gray-400">%</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold">Indice Plast.</div>
                <div class="text-3xl font-bold text-gray-800" id="res-pi">--</div>
                <div class="text-xs text-gray-400">%</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex-1 p-4 flex flex-col">
            <h3 class="font-bold text-gray-700 mb-2">üìà Curva de Flidez</h3>
            <div class="flex-1 relative w-full h-full min-h-[300px]">
                <canvas id="flowCurveCheck"></canvas>
            </div>
        </div>

        <!-- Validation Panel -->
        <div id="validationPanel" class="hidden bg-white rounded-xl shadow border border-gray-100 p-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-sm font-bold text-gray-500 uppercase">üìä Validaci√≥n vs CARTILLA</h4>
                <select id="sucs-select" class="text-sm border rounded px-2 py-1" onchange="validateAgainstSUCS()">
                    <option value="">-- Seleccionar Suelo --</option>
                    <option value="SM">SM - Arena Limosa</option>
                    <option value="ML">ML - Limo</option>
                    <option value="SC">SC - Arena Arcillosa</option>
                    <option value="CL">CL - Arcilla Baja Plasticidad</option>
                    <option value="MH">MH - Limo El√°stico</option>
                    <option value="CH">CH - Arcilla Alta Plasticidad</option>
                    <option value="OL">OL - Limo/Arcilla Org√°nico</option>
                    <option value="OH">OH - Arcilla Org√°nica Alta LL</option>
                </select>
            </div>
            <div id="validation-results" class="space-y-2 text-sm">
                <p class="text-gray-500 italic">Calcule primero, luego seleccione un tipo de suelo</p>
            </div>
        </div>
    </div>
</div>

<script>
    let chartInstance = null;

    function initChart() {
        const ctx = document.getElementById('flowCurveCheck').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Puntos de Ensayo',
                        data: [],
                        backgroundColor: '#2563eb',
                        pointRadius: 6
                    },
                    {
                        label: 'L√≠nea de Tendencia',
                        data: [],
                        type: 'line',
                        borderColor: '#9333ea',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: 'L√≠mite L√≠quido (N=25)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        pointRadius: 6,
                        pointStyle: 'star'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'logarithmic',
                        title: { display: true, text: 'N√∫mero de Golpes (N)' },
                        min: 10,
                        max: 60
                    },
                    y: {
                        title: { display: true, text: 'Contenido de Humedad (%)' }
                    }
                }
            }
        });
    }

    async function calculateLimits() {
        // Gather LL Data
        const llRows = document.querySelectorAll('.ll-row');
        const llData = Array.from(llRows).map(row => ({
            blows: parseFloat(row.querySelector('.blows').value) || 0,
            wet_tare: parseFloat(row.querySelector('.wt').value) || 0,
            dry_tare: parseFloat(row.querySelector('.dt').value) || 0,
            tare: parseFloat(row.querySelector('.t').value) || 0
        }));

        // Gather PL Data
        const plRows = document.querySelectorAll('.pl-row');
        const plData = Array.from(plRows).map(row => ({
            wet_tare: parseFloat(row.querySelector('.wt').value) || 0,
            dry_tare: parseFloat(row.querySelector('.dt').value) || 0,
            tare: parseFloat(row.querySelector('.t').value) || 0
        }));

        const response = await fetch('/limites', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ll_data: llData, pl_data: plData })
        });

        const result = await response.json();
        if (result.error) {
            alert(result.error);
            return;
        }

        const r = result.results;
        document.getElementById('res-ll').innerText = r.LL.toFixed(1);
        document.getElementById('res-pl').innerText = r.PL.toFixed(1);
        document.getElementById('res-pi').innerText = r.PI.toFixed(1);

        updateChart(r);
    }

    function updateChart(results) {
        // 1. Plot Points
        const points = results.ll_points.map(p => ({ x: p.blows, y: p.moisture }));
        chartInstance.data.datasets[0].data = points;

        // 2. Plot Trend Line (10 to 50 blows) using equation w = -m log(N) + c
        // Line equation: y = slope * log10(x) + intercept
        if (results.equation) {
            const slope = results.equation.slope;
            const intercept = results.equation.intercept;

            const startX = 10;
            const endX = 60;

            const lineData = [
                { x: startX, y: slope * Math.log10(startX) + intercept },
                { x: endX, y: slope * Math.log10(endX) + intercept }
            ];
            chartInstance.data.datasets[1].data = lineData;

            // 3. Mark LL Point
            chartInstance.data.datasets[2].data = [{ x: 25, y: results.LL }];
        }

        chartInstance.update();
    }

    // Store values for validation
    let lastLL = null, lastPL = null, lastPI = null;

    async function validateAgainstSUCS() {
        const sucs = document.getElementById('sucs-select').value;
        const resultsDiv = document.getElementById('validation-results');

        if (!sucs || lastLL === null) {
            resultsDiv.innerHTML = '<p class="text-gray-500 italic">Calcule primero, luego seleccione un tipo de suelo</p>';
            return;
        }

        const response = await fetch('/validar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sucs: sucs,
                params: { ll: lastLL, lp: lastPL, ip: lastPI }
            })
        });

        const result = await response.json();

        let html = `<div class="font-medium mb-2">${result.soil_name} (${result.category})</div>`;
        result.details.forEach(d => {
            let bgClass = 'bg-green-100 text-green-800';
            let icon = '‚úÖ';
            if (d.status === 'warning') { bgClass = 'bg-yellow-100 text-yellow-800'; icon = '‚ö†Ô∏è'; }
            else if (d.status === 'error') { bgClass = 'bg-red-100 text-red-800'; icon = '‚ùå'; }
            html += `<div class="p-2 rounded ${bgClass}">${icon} ${d.message}</div>`;
        });
        html += result.valid
            ? '<div class="mt-2 p-2 bg-green-200 text-green-900 rounded font-bold text-center">‚úÖ V√ÅLIDO para ' + sucs + '</div>'
            : '<div class="mt-2 p-2 bg-red-200 text-red-900 rounded font-bold text-center">‚ùå Fuera de rango para ' + sucs + '</div>';
        resultsDiv.innerHTML = html;
    }

    // Wrap calculateLimits to store values
    const origCalculateLimits = calculateLimits;
    async function calculateLimits() {
        await origCalculateLimits();
    }

    // Hook into result update
    const origUpdateChart = updateChart;
    function storeAndUpdate(results) {
        lastLL = results.LL;
        lastPL = results.PL;
        lastPI = results.PI;
        origUpdateChart(results);
        document.getElementById('validationPanel').classList.remove('hidden');
        if (document.getElementById('sucs-select').value) validateAgainstSUCS();
    }

    initChart();

</script>
{% endblock %}