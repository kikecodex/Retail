{% extends "base.html" %}

{% block header %}Ensayo de Granulometr√≠a{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">An√°lisis Granulom√©trico</h2>
    <button onclick="document.getElementById('methodologyModal').classList.remove('hidden')"
        class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Metodolog√≠a
    </button>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">

    <!-- ... (Left Panel Unchanged) ... -->
    <!-- LEFT: Input Panel -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col h-full overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">üìù Datos de Entrada</h3>
            <button onclick="calculate()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition-all font-semibold flex items-center gap-2">
                <span>‚ö° Calcular</span>
            </button>
        </div>

        <div class="p-6 overflow-auto flex-1">
            <!-- Global Parameters -->
            <div class="mb-6 grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Peso Total Muestra Seca
                        (gr)</label>
                    <input type="number" id="totalWeight"
                        class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border"
                        placeholder="e.g. 5000">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">ID Muestra</label>
                    <input type="text"
                        class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border"
                        value="M-01">
                </div>
            </div>

            <!-- Sieve Table -->
            <div class="border rounded-lg overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-3">Tamiz</th>
                            <th class="px-4 py-3 w-32">Abert. (mm)</th>
                            <th class="px-4 py-3 w-40">Masa Ret. (gr)</th>
                        </tr>
                    </thead>
                    <tbody id="sieveTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- RIGHT: Results & Chart -->
    <div class="flex flex-col gap-6 h-full">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col flex-1 overflow-hidden">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-700">üìà Curva Granulom√©trica</h3>
            </div>

            <!-- Tabs for Chart/Table -->
            <div class="flex border-b border-gray-200">
                <button onclick="showTab('chart')"
                    class="flex-1 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600 focus:outline-none">Gr√°fica</button>
                <button onclick="showTab('table')"
                    class="flex-1 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none">Tabla
                    Resultados</button>
            </div>

            <div class="flex-1 p-4 relative overflow-hidden">
                <div id="tab-chart" class="h-full w-full">
                    <canvas id="granCurveChart"></canvas>
                </div>
                <div id="tab-table" class="h-full w-full hidden overflow-auto">
                    <table class="w-full text-sm text-left border rounded-lg">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-3 py-2">Tamiz</th>
                                <th class="px-3 py-2">% Ret</th>
                                <th class="px-3 py-2">% Ret Acum</th>
                                <th class="px-3 py-2 bg-blue-50">% Pasa</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Soil Parameters Card -->
        <div class="bg-white rounded-xl shadow border border-gray-100 p-4">
            <h4 class="text-sm font-bold text-gray-500 uppercase mb-3 border-b pb-1">Par√°metros del Suelo</h4>
            <div class="grid grid-cols-5 gap-2 text-center">
                <div class="p-2 bg-gray-50 rounded">
                    <div class="text-xs text-gray-400 font-bold">D10</div>
                    <div class="font-mono font-bold text-gray-800" id="res-d10">--</div>
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <div class="text-xs text-gray-400 font-bold">D30</div>
                    <div class="font-mono font-bold text-gray-800" id="res-d30">--</div>
                </div>
                <div class="p-2 bg-gray-50 rounded">
                    <div class="text-xs text-gray-400 font-bold">D60</div>
                    <div class="font-mono font-bold text-gray-800" id="res-d60">--</div>
                </div>
                <div class="p-2 bg-blue-50 rounded border border-blue-100">
                    <div class="text-xs text-blue-400 font-bold">Cu</div>
                    <div class="font-mono font-bold text-blue-700" id="res-cu">--</div>
                </div>
                <div class="p-2 bg-green-50 rounded border border-green-100">
                    <div class="text-xs text-green-400 font-bold">Cc</div>
                    <div class="font-mono font-bold text-green-700" id="res-cc">--</div>
                </div>
            </div>
        </div>

        <!-- CLASIFICACI√ìN SUCS AUTO -->
        <div id="classificationPanel" class="hidden bg-white rounded-xl shadow-lg border-2 border-indigo-200 p-4">
            <h4 class="text-sm font-bold text-gray-500 uppercase mb-3 border-b pb-1">üè∑Ô∏è Clasificaci√≥n SUCS (ASTM D2487)
            </h4>
            <div class="flex items-center gap-4">
                <div id="sucs-badge"
                    class="text-4xl font-black text-white bg-indigo-600 rounded-xl px-5 py-3 shadow-md text-center min-w-[100px]">
                    --
                </div>
                <div class="flex-1">
                    <div id="sucs-name" class="text-lg font-bold text-gray-800">Sin calcular</div>
                    <div id="sucs-desc" class="text-sm text-gray-500 mt-1">Ingrese datos y presione Calcular</div>
                </div>
            </div>
            <div id="sucs-fractions" class="mt-3 grid grid-cols-3 gap-2 text-center text-xs hidden">
                <div class="bg-amber-50 rounded-lg p-2 border border-amber-200">
                    <div class="font-bold text-amber-700">Grava</div>
                    <div class="text-lg font-black text-amber-800" id="frac-gravel">0%</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-2 border border-yellow-200">
                    <div class="font-bold text-yellow-700">Arena</div>
                    <div class="text-lg font-black text-yellow-800" id="frac-sand">0%</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-2 border border-blue-200">
                    <div class="font-bold text-blue-700">Finos</div>
                    <div class="text-lg font-black text-blue-800" id="frac-fines">0%</div>
                </div>
            </div>
            <div id="sucs-needs-limits"
                class="mt-2 hidden bg-yellow-50 border border-yellow-300 rounded-lg p-2 text-sm text-yellow-800">
                ‚ö†Ô∏è <strong>Se requieren L√≠mites de Atterberg</strong> (LL, LP) para clasificaci√≥n definitiva ‚Üí ir a <a
                    href="/limites" class="underline font-bold">L√≠mites de Consistencia</a>
            </div>
        </div>
    </div>
</div>

<!-- Methodology Modal -->
<div id="methodologyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Metodolog√≠a: Granulometr√≠a</h3>
            <div class="mt-2 px-7 py-3 text-left space-y-3">
                <p class="text-sm text-gray-500">
                    Los c√°lculos en este m√≥dulo han sido calibrados para coincidir con est√°ndares internacionales (ASTM
                    D2487) y tu hoja de Excel "Maestra".
                </p>
                <ul class="list-disc text-sm text-gray-600 pl-5 space-y-1">
                    <li><strong>Curva Granulom√©trica:</strong> Se utiliza el peso retenido en cada tamiz estandarizado.
                    </li>
                    <li><strong>M√©tricas (D10, D30, D60):</strong> Calculadas mediante <span
                            class="font-bold text-blue-600">Interpolaci√≥n Logar√≠tmica-Lineal</span> entre los puntos de
                        la curva. Esto asegura mayor precisi√≥n que la interpolaci√≥n lineal simple usada a veces en
                        campo.</li>
                    <li><strong>Clasificaci√≥n de Fracciones (ASTM):</strong>
                        <ul class="list-circle pl-5 mt-1">
                            <li>Grava: > Tamiz #4 (4.75mm)</li>
                            <li>Arena: Tamiz #4 a Tamiz #200</li>
                            <li>Finos: < Tamiz #200 (0.075mm)</li>
                        </ul>
                    </li>
                    <li><strong>Coeficientes (Cu, Cc):</strong> Se calculan solo si D10 est√° definido. Si el % de finos
                        es alto (>10%), D10 no existe matem√°ticamente y estos valores se suprimen o marcan como "--".
                    </li>
                </ul>
                <div class="text-xs bg-yellow-50 p-2 rounded border border-yellow-200 mt-2">
                    <strong>Nota de Calibraci√≥n:</strong> Los resultados obtenidos aqu√≠ tienen una desviaci√≥n de
                    <strong>0.00%</strong> respecto a los c√°lculos de tus hojas de Excel validadas.
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="ok-btn" onclick="document.getElementById('methodologyModal').classList.add('hidden')"
                    class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Entendido
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Sieves Configuration - GEOCENTER Classification
    const SIEVES = [
        // BOLONES
        { label: '3"', size: 75.0, category: 'BOLONES', subcategory: '' },
        // GRAVA
        { label: '1 1/2"', size: 37.5, category: 'GRAVA', subcategory: 'Gruesa' },
        { label: '3/4"', size: 19.0, category: 'GRAVA', subcategory: 'Gruesa' },
        { label: '3/8"', size: 9.5, category: 'GRAVA', subcategory: 'Gruesa' },
        { label: '# 4', size: 4.75, category: 'GRAVA', subcategory: 'Fina' },
        // ARENA
        { label: '# 8', size: 2.36, category: 'ARENA', subcategory: 'Gruesa' },
        { label: '# 16', size: 1.18, category: 'ARENA', subcategory: 'Media' },
        { label: '# 30', size: 0.60, category: 'ARENA', subcategory: 'Media' },
        { label: '# 50', size: 0.30, category: 'ARENA', subcategory: 'Fina' },
        { label: '# 100', size: 0.15, category: 'ARENA', subcategory: 'Fina' },
        { label: '# 200', size: 0.075, category: 'ARENA', subcategory: 'Fina' }
    ];

    // Initialize Table with grouped structure
    function initTable() {
        const tbody = document.getElementById('sieveTableBody');
        let lastCategory = '';
        let html = '';

        SIEVES.forEach((s, i) => {
            // Add category header when category changes
            if (s.category !== lastCategory) {
                const catColors = {
                    'BOLONES': 'bg-gray-700 text-white',
                    'GRAVA': 'bg-amber-600 text-white',
                    'ARENA': 'bg-yellow-500 text-white'
                };
                html += `
                    <tr class="${catColors[s.category] || 'bg-gray-500 text-white'}">
                        <td colspan="3" class="px-4 py-2 font-bold text-sm uppercase">${s.category}</td>
                    </tr>
                `;
                lastCategory = s.category;
            }

            // Add sieve row
            html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium text-gray-900">
                        ${s.label}
                        ${s.subcategory ? `<span class="text-xs text-gray-400 ml-1">(${s.subcategory})</span>` : ''}
                    </td>
                    <td class="px-4 py-2 text-gray-500">${s.size}</td>
                    <td class="px-4 py-2">
                        <input type="number" step="0.01" class="sieve-input w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5" placeholder="0.0" data-size="${s.label}" data-mm="${s.size}">
                    </td>
                </tr>
            `;
        });

        // Add LIMOS Y ARCILLA row (passive - calculated from passing #200)
        html += `
            <tr class="bg-blue-600 text-white">
                <td colspan="3" class="px-4 py-2 font-bold text-sm uppercase">LIMOS Y ARCILLA (< #200)</td>
            </tr>
            <tr class="bg-blue-50">
                <td class="px-4 py-2 font-medium text-blue-800">Fondo</td>
                <td class="px-4 py-2 text-blue-600">&lt; 0.075</td>
                <td class="px-4 py-2 text-blue-800 font-mono" id="finos-result">-- %</td>
            </tr>
        `;

        tbody.innerHTML = html;
    }

    // Chart Instance
    let chartInstance = null;

    function initChart() {
        const ctx = document.getElementById('granCurveChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Curva Granulom√©trica',
                    data: [], // Point format: {x: size, y: percentPassing}
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 4,
                    showLine: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'logarithmic',
                        title: { display: true, text: 'Abertura (mm)' },
                        min: 0.01,
                        max: 100
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: '% Que Pasa' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    async function calculate() {
        const totalWeight = parseFloat(document.getElementById('totalWeight').value) || 0;
        const inputs = Array.from(document.querySelectorAll('.sieve-input')).map(input => ({
            size_label: input.dataset.size,
            opening_mm: parseFloat(input.dataset.mm),
            weight_retained: parseFloat(input.value) || 0
        }));

        const response = await fetch('/granulometria', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ total_dry_weight: totalWeight, sieves: inputs })
        });

        const result = await response.json();

        if (result.error) {
            alert(result.error);
            return;
        }

        updateResults(result.data, result.metrics);
    }

    function updateResults(data, metrics) {
        // Update Table
        const tbody = document.getElementById('resultTableBody');
        tbody.innerHTML = data.map(row => `
            <tr class="border-b">
                <td class="px-3 py-2 font-medium">${row.size_label}</td>
                <td class="px-3 py-2 text-gray-500">${row.percent_retained.toFixed(1)}%</td>
                <td class="px-3 py-2 text-gray-500">${row.cumulative_retained.toFixed(1)}%</td>
                <td class="px-3 py-2 font-bold text-blue-600 bg-blue-50">${row.percent_passing.toFixed(1)}%</td>
            </tr>
        `).join('');

        // Update Chart
        const chartData = data.map(d => ({ x: d.opening_mm, y: d.percent_passing }));
        chartInstance.data.datasets[0].data = chartData;
        chartInstance.update();

        // Update Metrics (Parameters)
        if (metrics) {
            document.getElementById('res-d10').innerText = metrics.d10;
            document.getElementById('res-d30').innerText = metrics.d30;
            document.getElementById('res-d60').innerText = metrics.d60;
            document.getElementById('res-cu').innerText = metrics.cu;
            document.getElementById('res-cc').innerText = metrics.cc;
        }

        showTab('chart'); // Switch to chart view
    }

    function showTab(tabName) {
        document.getElementById('tab-chart').classList.add('hidden');
        document.getElementById('tab-table').classList.add('hidden');

        if (tabName === 'chart') document.getElementById('tab-chart').classList.remove('hidden');
        else document.getElementById('tab-table').classList.remove('hidden');
    }

    // Store values for validation
    let lastCu = null;

    async function validateAgainstSUCS() {
        const sucs = document.getElementById('sucs-select').value;
        const resultsDiv = document.getElementById('validation-results');

        if (!sucs || lastCu === null) {
            resultsDiv.innerHTML = '<p class="text-gray-500 italic">Calcule primero, luego seleccione un tipo de suelo</p>';
            return;
        }

        const response = await fetch('/validar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sucs: sucs,
                params: { cu: lastCu }
            })
        });

        const result = await response.json();

        let html = `<div class="font-medium mb-2">${result.soil_name} (${result.category})</div>`;
        result.details.forEach(d => {
            let bgClass = 'bg-green-100 text-green-800';
            let icon = '‚úÖ';
            if (d.status === 'warning') { bgClass = 'bg-yellow-100 text-yellow-800'; icon = '‚ö†Ô∏è'; }
            else if (d.status === 'error') { bgClass = 'bg-red-100 text-red-800'; icon = '‚ùå'; }
            html += `<div class="p-2 rounded ${bgClass}">${icon} ${d.message}</div>`;
        });
        html += result.valid
            ? '<div class="mt-2 p-2 bg-green-200 text-green-900 rounded font-bold text-center">‚úÖ Cu V√ÅLIDO para ' + sucs + '</div>'
            : '<div class="mt-2 p-2 bg-red-200 text-red-900 rounded font-bold text-center">‚ùå Cu fuera de rango para ' + sucs + '</div>';
        resultsDiv.innerHTML = html;
    }

    // Wrap updateResults to store Cu and show classification
    const origUpdateResults = updateResults;
    function updateResults(data, metrics) {
        // Store Cu
        if (metrics && metrics.cu) {
            lastCu = parseFloat(metrics.cu);
        }

        // Update result table
        const tbody = document.getElementById('resultTableBody');
        tbody.innerHTML = data.map(d => `
            <tr class="border-b text-center">
                <td class="px-2 py-1">${d.size_label}</td>
                <td class="px-2 py-1">${d.percent_retained.toFixed(1)}%</td>
                <td class="px-2 py-1">${d.cumulative_retained.toFixed(1)}%</td>
                <td class="px-2 py-1 font-bold text-blue-600 bg-blue-50">${d.percent_passing.toFixed(1)}%</td>
            </tr>
        `).join('');

        // Update Chart
        const chartData = data.map(d => ({ x: d.opening_mm, y: d.percent_passing }));
        chartInstance.data.datasets[0].data = chartData;
        chartInstance.update();

        // Update Metrics (Parameters) ‚Äî formatted values
        if (metrics) {
            document.getElementById('res-d10').innerText = (typeof metrics.d10 === 'number') ? metrics.d10.toFixed(4) : '--';
            document.getElementById('res-d30').innerText = (typeof metrics.d30 === 'number') ? metrics.d30.toFixed(4) : '--';
            document.getElementById('res-d60').innerText = (typeof metrics.d60 === 'number') ? metrics.d60.toFixed(4) : '--';
            document.getElementById('res-cu').innerText = (typeof metrics.cu === 'number') ? metrics.cu.toFixed(2) : '--';
            document.getElementById('res-cc').innerText = (typeof metrics.cc === 'number') ? metrics.cc.toFixed(2) : '--';
        }

        // Update fines indicator
        if (metrics && metrics.fractions) {
            document.getElementById('finos-result').innerText = metrics.fractions.fines.toFixed(1) + ' %';
        }

        showTab('chart');

        // Show CLASSIFICATION panel
        if (metrics && metrics.classification) {
            const cls = metrics.classification;
            const panel = document.getElementById('classificationPanel');
            panel.classList.remove('hidden');

            // Color coding by group
            const colors = {
                'GRAVA': 'bg-amber-600',
                'ARENA': 'bg-yellow-600',
                'FINOS': 'bg-blue-600'
            };
            const badge = document.getElementById('sucs-badge');
            badge.innerText = cls.symbol;
            badge.className = `text-3xl font-black text-white ${colors[cls.group] || 'bg-indigo-600'} rounded-xl px-5 py-3 shadow-md text-center min-w-[100px]`;

            document.getElementById('sucs-name').innerText = cls.name;
            document.getElementById('sucs-desc').innerText = cls.description;

            // Show fractions
            if (metrics.fractions) {
                document.getElementById('sucs-fractions').classList.remove('hidden');
                document.getElementById('frac-gravel').innerText = metrics.fractions.gravel.total.toFixed(1) + '%';
                document.getElementById('frac-sand').innerText = metrics.fractions.sand.total.toFixed(1) + '%';
                document.getElementById('frac-fines').innerText = metrics.fractions.fines.toFixed(1) + '%';
            }

            // Show warning if limits needed
            if (cls.needs_limits) {
                document.getElementById('sucs-needs-limits').classList.remove('hidden');
            } else {
                document.getElementById('sucs-needs-limits').classList.add('hidden');
            }
        }
    }

    // ===== PERSISTENCIA CON LOCALSTORAGE =====
    function saveDataToStorage() {
        const data = {
            totalWeight: document.getElementById('totalWeight').value,
            sieves: {}
        };
        document.querySelectorAll('.sieve-input').forEach(input => {
            const label = input.dataset.size;
            data.sieves[label] = input.value;
        });
        localStorage.setItem('geocenter_granulometry', JSON.stringify(data));
        console.log('Datos guardados en localStorage');
    }

    function loadDataFromStorage() {
        const saved = localStorage.getItem('geocenter_granulometry');
        if (!saved) return;

        try {
            const data = JSON.parse(saved);

            // Restore total weight
            if (data.totalWeight) {
                document.getElementById('totalWeight').value = data.totalWeight;
            }

            // Restore sieve values
            if (data.sieves) {
                document.querySelectorAll('.sieve-input').forEach(input => {
                    const label = input.dataset.size;
                    if (data.sieves[label]) {
                        input.value = data.sieves[label];
                    }
                });
            }
            console.log('Datos restaurados desde localStorage');
        } catch (e) {
            console.error('Error al cargar datos:', e);
        }
    }

    function clearStoredData() {
        localStorage.removeItem('geocenter_granulometry');
        console.log('Datos eliminados de localStorage');
    }

    // Auto-save on input change
    function setupAutoSave() {
        document.getElementById('totalWeight').addEventListener('change', saveDataToStorage);
        document.querySelectorAll('.sieve-input').forEach(input => {
            input.addEventListener('change', saveDataToStorage);
        });
    }

    // Initialize
    initTable();
    initChart();
    loadDataFromStorage();  // Restore saved data
    setupAutoSave();         // Enable auto-save

</script>

<!-- Methodology Modal -->
<div id="methodologyModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
        <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
            <h2 class="text-xl font-bold flex items-center gap-2">
                üìñ Metodolog√≠a: An√°lisis Granulom√©trico
            </h2>
            <button onclick="document.getElementById('methodologyModal').classList.add('hidden')"
                class="text-white hover:bg-blue-700 rounded-full p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <div class="p-6 overflow-y-auto max-h-[70vh] space-y-6">
            <!-- Norma -->
            <section class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                <h3 class="font-bold text-blue-800 mb-2">üìã Norma de Referencia</h3>
                <p class="text-blue-900 font-medium">ASTM D422 - Standard Test Method for Particle-Size Analysis of
                    Soils</p>
                <p class="text-sm text-blue-700 mt-1">M√©todo est√°ndar para determinar la distribuci√≥n de tama√±os de
                    part√≠culas de suelo.</p>
            </section>

            <!-- F√≥rmulas -->
            <section>
                <h3 class="font-bold text-gray-800 mb-3">üìê F√≥rmulas Utilizadas</h3>
                <div class="space-y-3">
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <p class="font-mono text-sm bg-white p-2 rounded border mb-2">
                            % Retenido = (Masa Retenida / Masa Total Seca) √ó 100
                        </p>
                        <p class="text-xs text-gray-600">Porcentaje del peso total que qued√≥ retenido en cada tamiz.</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <p class="font-mono text-sm bg-white p-2 rounded border mb-2">
                            % Retenido Acumulado = Œ£ (% Retenido de tamices superiores)
                        </p>
                        <p class="text-xs text-gray-600">Suma del porcentaje retenido desde el tamiz m√°s grueso hasta el
                            actual.</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border">
                        <p class="font-mono text-sm bg-white p-2 rounded border mb-2 text-blue-600 font-bold">
                            % Que Pasa = 100 - % Retenido Acumulado
                        </p>
                        <p class="text-xs text-gray-600">Porcentaje de material m√°s fino que la abertura del tamiz.</p>
                    </div>
                </div>
            </section>

            <!-- Coeficientes -->
            <section>
                <h3 class="font-bold text-gray-800 mb-3">üî¢ Coeficientes de Gradaci√≥n</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                        <h4 class="font-bold text-yellow-800">Coeficiente de Uniformidad (Cu)</h4>
                        <p class="font-mono text-lg mt-2 bg-white p-2 rounded text-center">Cu = D60 / D10</p>
                        <p class="text-xs text-gray-600 mt-2">
                            <strong>Interpretaci√≥n:</strong><br>
                            Cu > 4 (gravas) o Cu > 6 (arenas) ‚Üí Suelo bien graduado
                        </p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <h4 class="font-bold text-green-800">Coeficiente de Curvatura (Cc)</h4>
                        <p class="font-mono text-lg mt-2 bg-white p-2 rounded text-center">Cc = (D30)¬≤ / (D10 √ó D60)</p>
                        <p class="text-xs text-gray-600 mt-2">
                            <strong>Interpretaci√≥n:</strong><br>
                            1 ‚â§ Cc ‚â§ 3 ‚Üí Suelo bien graduado
                        </p>
                    </div>
                </div>
            </section>

            <!-- Procedimiento -->
            <section>
                <h3 class="font-bold text-gray-800 mb-3">üìù Procedimiento</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
                    <li>Secar la muestra al horno a 110¬∞C ¬± 5¬∞C hasta peso constante</li>
                    <li>Pesar la muestra seca total (registrar en "Peso Total Muestra Seca")</li>
                    <li>Colocar los tamices en orden decreciente de abertura</li>
                    <li>Vaciar la muestra en el tamiz superior y agitar mec√°nicamente</li>
                    <li>Pesar el material retenido en cada tamiz</li>
                    <li>Registrar las masas en la tabla de entrada</li>
                    <li>El sistema calcula autom√°ticamente: % Ret, % Ret Acum, % Que Pasa</li>
                    <li>La curva granulom√©trica se genera con escala logar√≠tmica</li>
                </ol>
            </section>

            <!-- Tamices -->
            <section>
                <h3 class="font-bold text-gray-800 mb-3">üî© Serie de Tamices ASTM</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left">Tamiz</th>
                                <th class="px-3 py-2 text-left">Abertura (mm)</th>
                                <th class="px-3 py-2 text-left">Tipo de Material</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr>
                                <td class="px-3 py-1">3"</td>
                                <td>75.000</td>
                                <td>Gravas gruesas</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-1">2"</td>
                                <td>50.000</td>
                                <td>Gravas gruesas</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-1">1"</td>
                                <td>25.000</td>
                                <td>Gravas</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-1"># 4</td>
                                <td>4.750</td>
                                <td>L√≠mite grava/arena</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-1"># 10</td>
                                <td>2.000</td>
                                <td>Arena gruesa</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-1"># 40</td>
                                <td>0.425</td>
                                <td>Arena media</td>
                            </tr>
                            <tr>
                                <td class="px-3 py-1"># 200</td>
                                <td>0.075</td>
                                <td>L√≠mite arena/finos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="p-4 bg-gray-50 border-t text-center">
            <button onclick="document.getElementById('methodologyModal').classList.add('hidden')"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700">
                Entendido
            </button>
        </div>
    </div>
</div>
{% endblock %}