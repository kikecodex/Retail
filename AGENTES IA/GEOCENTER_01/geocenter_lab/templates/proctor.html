{% extends "base.html" %}
{% block header %}Ensayo Proctor Modificado (ASTM D1557){% endblock %}
{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Proctor Modificado</h2>
    <button onclick="document.getElementById('methodologyModalProctor').classList.remove('hidden')"
        class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Metodolog√≠a
    </button>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
    <!-- LEFT: Input Panel -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">üî® Datos del Molde y Muestras</h3>
            <button onclick="calculateProctor()"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-md transition-all font-semibold flex items-center gap-2">
                ‚ö° Calcular
            </button>
        </div>

        <div class="p-6 overflow-auto flex-1 space-y-6">
            <!-- Mold Parameters -->
            <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                <h4 class="text-sm font-bold text-red-600 uppercase mb-3">Par√°metros del Molde</h4>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Altura (cm)</label>
                        <input type="number" step="0.01" id="moldHeight" value="11.65"
                            class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 p-2 border">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Di√°metro (cm)</label>
                        <input type="number" step="0.01" id="moldDiameter" value="15.2"
                            class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 p-2 border">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Peso Molde (g)</label>
                        <input type="number" step="0.01" id="moldWeight" value="4200"
                            class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 p-2 border">
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    Volumen calculado: <span id="moldVolume" class="font-mono font-bold">-- cm¬≥</span>
                </div>
            </div>

            <!-- Points Data Entry -->
            <div>
                <h4 class="text-sm font-bold text-gray-600 uppercase mb-3">Puntos de Compactaci√≥n (5)</h4>
                <div class="space-y-4" id="pointsContainer">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: Results & Chart -->
    <div class="flex flex-col gap-6 h-full">
        <!-- Results Cards -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-red-500 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold">Densidad Seca M√°xima</div>
                <div class="text-3xl font-bold text-gray-800" id="res-mdd">--</div>
                <div class="text-xs text-gray-400">g/cm¬≥</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold">Humedad √ìptima</div>
                <div class="text-3xl font-bold text-gray-800" id="res-omc">--</div>
                <div class="text-xs text-gray-400">%</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex-1 p-4 flex flex-col">
            <h3 class="font-bold text-gray-700 mb-2">üìà Curva de Compactaci√≥n</h3>
            <div class="flex-1 relative w-full h-full min-h-[300px]">
                <canvas id="proctorChart"></canvas>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white rounded-xl shadow border border-gray-100 p-4">
            <h4 class="text-sm font-bold text-gray-500 uppercase mb-3">Resultados por Punto</h4>
            <table class="w-full text-sm">
                <thead class="bg-gray-100 text-xs uppercase">
                    <tr>
                        <th class="p-2">Punto</th>
                        <th class="p-2">Humedad (%)</th>
                        <th class="p-2">Œ≥ H√∫meda</th>
                        <th class="p-2">Œ≥ Seca</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody" class="text-center">
                    <tr>
                        <td colspan="4" class="py-4 text-gray-400">Sin datos</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Validation Panel for MDD/OMC -->
        <div id="validationPanel" class="hidden bg-white rounded-xl shadow border border-gray-100 p-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-sm font-bold text-gray-500 uppercase">üìä Validaci√≥n MDD/OMC vs CARTILLA</h4>
                <select id="sucs-select" class="text-sm border rounded px-2 py-1" onchange="validateAgainstSUCS()">
                    <option value="">-- Seleccionar Suelo --</option>
                    <option value="GW">GW - Grava Bien Graduada</option>
                    <option value="GP">GP - Grava Mal Graduada</option>
                    <option value="GM">GM - Grava Limosa</option>
                    <option value="GC">GC - Grava Arcillosa</option>
                    <option value="SW">SW - Arena Bien Graduada</option>
                    <option value="SP">SP - Arena Mal Graduada</option>
                    <option value="SM">SM - Arena Limosa</option>
                    <option value="SC">SC - Arena Arcillosa</option>
                    <option value="ML">ML - Limo</option>
                    <option value="CL">CL - Arcilla Baja Plasticidad</option>
                </select>
            </div>
            <div id="validation-results" class="space-y-2 text-sm">
                <p class="text-gray-500 italic">Calcule primero, luego seleccione un tipo de suelo</p>
            </div>
        </div>
    </div>
</div>

<!-- Methodology Modal -->
<div id="methodologyModalProctor"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Metodolog√≠a: Proctor Modificado</h3>
            <div class="mt-2 px-7 py-3 text-left space-y-3">
                <p class="text-sm text-gray-500">
                    Ensayo de compactaci√≥n din√°mica seg√∫n ASTM D1557.
                </p>
                <ul class="list-disc text-sm text-gray-600 pl-5 space-y-1">
                    <li><strong>Volumen del Molde:</strong> <span class="font-mono bg-gray-100 px-1">V = œÄ √ó (D/2)¬≤ √ó
                            H</span></li>
                    <li><strong>Densidad H√∫meda:</strong> <span class="font-mono bg-gray-100 px-1">Œ≥w = (Molde+Suelo -
                            Molde) / V</span></li>
                    <li><strong>Densidad Seca:</strong> <span class="font-mono bg-gray-100 px-1">Œ≥d = Œ≥w / (1 +
                            w/100)</span></li>
                    <li><strong>Curva de Compactaci√≥n:</strong> Ajuste polin√≥mico de 2do grado para encontrar el pico.
                    </li>
                    <li><strong>MDD:</strong> Densidad Seca M√°xima (pico de la curva).</li>
                    <li><strong>OMC:</strong> Humedad √ìptima (humedad en el pico).</li>
                </ul>
                <div class="text-xs bg-yellow-50 p-2 rounded border border-yellow-200 mt-2">
                    <strong>Calibraci√≥n:</strong> F√≥rmulas extra√≠das directamente de tu Excel maestro.
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="document.getElementById('methodologyModalProctor').classList.add('hidden')"
                    class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700">
                    Entendido
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let chartInstance = null;

    function initPointsUI() {
        const container = document.getElementById('pointsContainer');
        let html = '';
        for (let i = 1; i <= 5; i++) {
            html += `
            <div class="border rounded-lg p-3 bg-gray-50">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-600">Punto ${i}</span>
                    <input type="number" step="0.01" class="mold-wet w-32 p-1 border rounded text-center text-sm" placeholder="Molde+Suelo (g)" data-point="${i}">
                </div>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div>
                        <label class="text-gray-400">Tara 1</label>
                        <input type="number" step="0.01" class="tare1 w-full p-1 border rounded" data-point="${i}">
                    </div>
                    <div>
                        <label class="text-gray-400">H√∫m+T 1</label>
                        <input type="number" step="0.01" class="wet1 w-full p-1 border rounded" data-point="${i}">
                    </div>
                    <div>
                        <label class="text-gray-400">Seco+T 1</label>
                        <input type="number" step="0.01" class="dry1 w-full p-1 border rounded" data-point="${i}">
                    </div>
                    <div>
                        <label class="text-gray-400">Tara 2</label>
                        <input type="number" step="0.01" class="tare2 w-full p-1 border rounded" data-point="${i}">
                    </div>
                    <div>
                        <label class="text-gray-400">H√∫m+T 2</label>
                        <input type="number" step="0.01" class="wet2 w-full p-1 border rounded" data-point="${i}">
                    </div>
                    <div>
                        <label class="text-gray-400">Seco+T 2</label>
                        <input type="number" step="0.01" class="dry2 w-full p-1 border rounded" data-point="${i}">
                    </div>
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }

    function updateMoldVolume() {
        const h = parseFloat(document.getElementById('moldHeight').value) || 0;
        const d = parseFloat(document.getElementById('moldDiameter').value) || 0;
        const v = Math.PI * Math.pow(d / 2, 2) * h;
        document.getElementById('moldVolume').innerText = v.toFixed(2) + ' cm¬≥';
    }

    function initChart() {
        const ctx = document.getElementById('proctorChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Puntos Medidos',
                        data: [],
                        backgroundColor: '#dc2626',
                        pointRadius: 6
                    },
                    {
                        label: 'Curva Ajustada',
                        data: [],
                        type: 'line',
                        borderColor: '#f97316',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.4
                    },
                    {
                        label: 'MDD/OMC',
                        data: [],
                        borderColor: '#16a34a',
                        backgroundColor: '#16a34a',
                        pointRadius: 8,
                        pointStyle: 'star'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Humedad (%)' } },
                    y: { title: { display: true, text: 'Densidad Seca (g/cm¬≥)' } }
                }
            }
        });
    }

    async function calculateProctor() {
        const mold = {
            height_cm: parseFloat(document.getElementById('moldHeight').value) || 0,
            diameter_cm: parseFloat(document.getElementById('moldDiameter').value) || 0,
            weight_g: parseFloat(document.getElementById('moldWeight').value) || 0
        };

        const points = [];
        for (let i = 1; i <= 5; i++) {
            const moldWet = parseFloat(document.querySelector(`.mold-wet[data-point="${i}"]`).value) || 0;
            const samples = [
                {
                    tare: parseFloat(document.querySelector(`.tare1[data-point="${i}"]`).value) || 0,
                    wet_tare: parseFloat(document.querySelector(`.wet1[data-point="${i}"]`).value) || 0,
                    dry_tare: parseFloat(document.querySelector(`.dry1[data-point="${i}"]`).value) || 0
                },
                {
                    tare: parseFloat(document.querySelector(`.tare2[data-point="${i}"]`).value) || 0,
                    wet_tare: parseFloat(document.querySelector(`.wet2[data-point="${i}"]`).value) || 0,
                    dry_tare: parseFloat(document.querySelector(`.dry2[data-point="${i}"]`).value) || 0
                }
            ];
            points.push({ samples, mold_wet_g: moldWet });
        }

        const response = await fetch('/proctor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mold, points })
        });

        const result = await response.json();
        if (result.error) {
            alert(result.error);
            return;
        }

        updateResults(result.results);
    }

    function updateResults(r) {
        // Update summary
        document.getElementById('res-mdd').innerText = r.mdd;
        document.getElementById('res-omc').innerText = r.omc;

        // Update table
        const tbody = document.getElementById('resultsTableBody');
        tbody.innerHTML = r.points.map(p => `
            <tr class="border-b">
                <td class="p-2 font-bold">${p.point_num}</td>
                <td class="p-2">${p.moisture_percent}%</td>
                <td class="p-2">${p.wet_density}</td>
                <td class="p-2 font-bold text-red-600">${p.dry_density}</td>
            </tr>
        `).join('');

        // Update chart
        const points = r.points.map(p => ({ x: p.moisture_percent, y: p.dry_density }));
        chartInstance.data.datasets[0].data = points;

        // Generate fitted curve
        if (r.equation && r.equation.a !== 0) {
            const a = r.equation.a, b = r.equation.b, c = r.equation.c;
            const wMin = Math.min(...r.points.map(p => p.moisture_percent)) - 1;
            const wMax = Math.max(...r.points.map(p => p.moisture_percent)) + 1;
            const curvePoints = [];
            for (let w = wMin; w <= wMax; w += 0.5) {
                curvePoints.push({ x: w, y: a * w * w + b * w + c });
            }
            chartInstance.data.datasets[1].data = curvePoints;
        }

        // Mark MDD/OMC
        chartInstance.data.datasets[2].data = [{ x: r.omc, y: r.mdd }];

        chartInstance.update();
    }

    // Init
    initPointsUI();
    initChart();
    updateMoldVolume();
    document.getElementById('moldHeight').addEventListener('input', updateMoldVolume);
    document.getElementById('moldDiameter').addEventListener('input', updateMoldVolume);

    // Store values for validation
    let lastMDD = null, lastOMC = null;

    async function validateAgainstSUCS() {
        const sucs = document.getElementById('sucs-select').value;
        const resultsDiv = document.getElementById('validation-results');

        if (!sucs || lastMDD === null) {
            resultsDiv.innerHTML = '<p class="text-gray-500 italic">Calcule primero, luego seleccione un tipo de suelo</p>';
            return;
        }

        const response = await fetch('/validar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sucs: sucs,
                params: {
                    gamma: lastMDD,      // MDD maps to gamma_compacta in CARTILLA
                    humidity: lastOMC    // OMC maps to humedad in CARTILLA
                }
            })
        });

        const result = await response.json();

        let html = `<div class="font-medium mb-2">${result.soil_name} (${result.category})</div>`;
        result.details.forEach(d => {
            let bgClass = 'bg-green-100 text-green-800';
            let icon = '‚úÖ';
            if (d.status === 'warning') { bgClass = 'bg-yellow-100 text-yellow-800'; icon = '‚ö†Ô∏è'; }
            else if (d.status === 'error') { bgClass = 'bg-red-100 text-red-800'; icon = '‚ùå'; }
            html += `<div class="p-2 rounded ${bgClass}">${icon} ${d.message}</div>`;
        });
        html += result.valid
            ? '<div class="mt-2 p-2 bg-green-200 text-green-900 rounded font-bold text-center">‚úÖ MDD/OMC V√ÅLIDOS para ' + sucs + '</div>'
            : '<div class="mt-2 p-2 bg-red-200 text-red-900 rounded font-bold text-center">‚ùå Fuera de rango para ' + sucs + '</div>';
        resultsDiv.innerHTML = html;
    }

    // Wrap updateResults to store values and show validation
    const origUpdateResults = updateResults;
    function updateResults(r) {
        // Store values
        lastMDD = r.mdd;
        lastOMC = r.omc;

        // Call original logic
        document.getElementById('res-mdd').innerText = r.mdd;
        document.getElementById('res-omc').innerText = r.omc;

        const tbody = document.getElementById('resultsTableBody');
        tbody.innerHTML = r.points.map(p => `
            <tr class="border-b">
                <td class="p-2 font-bold">${p.point_num}</td>
                <td class="p-2">${p.moisture_percent}%</td>
                <td class="p-2">${p.wet_density}</td>
                <td class="p-2 font-bold text-red-600">${p.dry_density}</td>
            </tr>
        `).join('');

        const points = r.points.map(p => ({ x: p.moisture_percent, y: p.dry_density }));
        chartInstance.data.datasets[0].data = points;

        if (r.equation && r.equation.a !== 0) {
            const a = r.equation.a, b = r.equation.b, c = r.equation.c;
            const wMin = Math.min(...r.points.map(p => p.moisture_percent)) - 1;
            const wMax = Math.max(...r.points.map(p => p.moisture_percent)) + 1;
            const curvePoints = [];
            for (let w = wMin; w <= wMax; w += 0.5) {
                curvePoints.push({ x: w, y: a * w * w + b * w + c });
            }
            chartInstance.data.datasets[1].data = curvePoints;
        }

        chartInstance.data.datasets[2].data = [{ x: r.omc, y: r.mdd }];
        chartInstance.update();

        // Show validation panel
        document.getElementById('validationPanel').classList.remove('hidden');
        if (document.getElementById('sucs-select').value) {
            validateAgainstSUCS();
        }
    }
</script>
{% endblock %}